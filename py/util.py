from contextlib import closing, contextmanager
import psycopg2


def exec_psql(statements, db=None):
    with closing(psycopg2.connect(user='postgres', database=db)) as conn:
        conn.set_session(autocommit=True)

        with conn.cursor() as cursor:
            for psql in statements:
                cursor.execute(psql)
                if cursor.description:
                    print(cursor.fetchall())


def create_database(db_name):
    exec_psql(["""CREATE DATABASE {}""".format(db_name)])


def drop_database(db_name):
    exec_psql([
        """UPDATE pg_database SET datallowconn='false' WHERE datname='{}'""".format(db_name),
        """SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname='{}'""".format(db_name),
        """DROP DATABASE {}""".format(db_name)])

@contextmanager
def database(db_name):
    try:
        create_database(db_name)

        yield
    except Exception as e:
        raise
    finally:
        drop_database(db_name)
